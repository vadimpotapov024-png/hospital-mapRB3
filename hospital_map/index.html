<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –±–æ–ª—å–Ω–∏—Ü–µ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f0f2f5;
        }
        #header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #search-container {
            padding: 15px;
            background: white;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        #search-input {
            flex: 3;
            min-width: 200px;
            padding: 12px 15px;
            font-size: 1.1rem;
            border: 2px solid #bdc3c7;
            border-radius: 30px;
            outline: none;
            transition: border 0.2s;
        }
        #search-input:focus {
            border-color: #3498db;
        }
        #search-btn, #reset-btn, #clear-start-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 30px;
            background: #3498db;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #search-btn:active, #reset-btn:active, #clear-start-btn:active {
            transform: scale(0.98);
        }
        #reset-btn {
            background: #95a5a6;
        }
        #reset-btn:hover {
            background: #7f8c8d;
        }
        #clear-start-btn {
            background: #e67e22;
        }
        #clear-start-btn:hover {
            background: #d35400;
        }
        #search-btn:hover {
            background: #2980b9;
        }
        #map {
            flex: 1;
            width: 100%;
            background: #ecf0f1;
        }
        #info-panel {
            background: white;
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            font-size: 1rem;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        .leaflet-popup-content {
            font-size: 1rem;
            font-weight: bold;
        }
        @media (max-width: 600px) {
            #header { font-size: 1.2rem; padding: 10px; }
            #search-container { flex-direction: column; }
            #search-input, #search-btn, #reset-btn, #clear-start-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="header">üè• –ù–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –±–æ–ª—å–Ω–∏—Ü–µ</div>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ, –∫–∞–±–∏–Ω–µ—Ç..." list="points-list">
        <datalist id="points-list"></datalist>
        <button id="search-btn">üîç –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
        <button id="reset-btn">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
        <button id="clear-start-btn">üó∫ –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ä—Ç</button>
    </div>
    <div id="map"></div>
    <div id="info-panel">
        <span id="info-text">üëÜ –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –∏–ª–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ä –æ—Ç–¥–µ–ª–µ–Ω–∏—è</span>
    </div>

    <script>
        // ---------- –ù–ê–°–¢–†–û–ô–ö–ò ----------
        const imgWidth = 1246;      // —à–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const imgHeight = 604;      // –≤—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const mapImagePath = '–∫–∞—Ä—Ç–∞ –ø–µ—Ä–≤—ã–π —ç—Ç–∞–∂.jpg'; // –∏–º—è —Ñ–∞–π–ª–∞ –∫–∞—Ä—Ç—ã
        const invertY = true;       // –∏–Ω–≤–µ—Ä—Å–∏—è –æ—Å–∏ Y (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ Paint –æ—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è)

        // ---------- –¢–û–ß–ö–ò (–æ—Ç–¥–µ–ª–µ–Ω–∏—è + –≤—Ö–æ–¥) ----------
        const points = [
            { id: 1, name: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω–∞—è –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞ –ü–î–¶', floor: 1, x: 548, y: 467, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 2, name: '–í–Ω–µ–±—é–¥–∂–µ—Ç–Ω—ã–π –¥–µ—Ç—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–¥–µ–ª', floor: 1, x: 684, y: 431, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 3, name: '–§–∏–∑–∏–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ', floor: 1, x: 764, y: 409, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 4, name: '–ü—Ä–∏–µ–º–Ω–æ-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ –ü–µ–¥–∏–∞—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞', floor: 1, x: 882, y: 380, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 5, name: '–ü—Ä–∏–µ–º–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ –∞–∫—É—à–µ—Ä—Å—Ç–≤–∞ –∏ –≥–∏–Ω–µ–∫–æ–ª–æ–≥–∏–∏', floor: 1, x: 1028, y: 341, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 6, name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –ü–µ—Ä–∏–Ω–∞—Ç–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞', floor: 1, x: 1094, y: 324, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 7, name: '–û—Ç–¥–µ–ª –ª—É—á–µ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (–ú–†–¢, —Ä–µ–Ω—Ç–≥–µ–Ω–∫–∞–±–∏–Ω–µ—Ç—ã, –∫–∞–±–∏–Ω–µ—Ç—ã –£–ó–ò)', floor: 1, x: 523, y: 326, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 8, name: '–ö–∞–±–∏–Ω–µ—Ç—ã –£–ó–ò', floor: 1, x: 679, y: 293, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 9, name: '–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü-–∑–∞–ª –¶–û–ú–∏–î', floor: 1, x: 184, y: 324, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 10, name: '–ü—Å–∏—Ö–æ–Ω–µ–≤—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ ‚Ññ1', floor: 1, x: 278, y: 270, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 11, name: '–Ø–∫—É—Ç—Å–∫–∏–π –Ω–∞—É—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä –ö–ú–ü –°–û –†–ê–ú–ù', floor: 1, x: 349, y: 251, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 12, name: '–ü—Å–∏—Ö–æ–Ω–µ–≤—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ ‚Ññ2', floor: 1, x: 456, y: 227, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 13, name: '–ö–∞—Ñ–µ–¥—Ä–∞ –ú–ò –°–í–§–£', floor: 1, x: 519, y: 212, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 14, name: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ –≥–Ω–æ–π–Ω–æ–π —Ö–∏—Ä—É—Ä–≥–∏–∏', floor: 1, x: 606, y: 196, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 15, name: '–ù–µ–π—Ä–æ—Ö–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ', floor: 1, x: 668, y: 180, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 16, name: '–ò–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Ä–æ–∂–¥–µ–Ω–Ω—ã—Ö', floor: 1, x: 770, y: 157, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            { id: 17, name: '–ü—Ä–∏–µ–º–Ω–æ–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–Ω–∞—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞', floor: 1, x: 834, y: 145, type: '–û—Ç–¥–µ–ª–µ–Ω–∏–µ' },
            // –í—Ö–æ–¥ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ –∫–∞—Ä—Ç–µ)
            { id: 18, name: '–í—Ö–æ–¥ –≤ –±–æ–ª—å–Ω–∏—Ü—É', floor: 1, x: 100, y: 400, type: '–í—Ö–æ–¥' }
        ];

        // ---------- –ü–û–°–¢–†–û–ï–ù–ò–ï –ì–†–ê–§–ê (K –ë–õ–ò–ñ–ê–ô–®–ò–• –°–û–°–ï–î–ï–ô) ----------
        function getDist(p1, p2) {
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            return Math.sqrt(dx*dx + dy*dy);
        }

        const K = 3; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–æ—Å–µ–¥–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
        const edges = [];

        for (let i = 0; i < points.length; i++) {
            const p1 = points[i];
            const distances = [];
            for (let j = 0; j < points.length; j++) {
                if (i === j) continue;
                const p2 = points[j];
                distances.push({ id: p2.id, dist: getDist(p1, p2) });
            }
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
            distances.sort((a, b) => a.dist - b.dist);
            // –ë–µ—Ä—ë–º K –±–ª–∏–∂–∞–π—à–∏—Ö
            for (let k = 0; k < Math.min(K, distances.length); k++) {
                const neighbor = distances[k];
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ —Ä–µ–±—Ä–æ (–≤ –ª—é–±–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏)
                const exists = edges.some(e => 
                    (e.from === p1.id && e.to === neighbor.id) || 
                    (e.from === neighbor.id && e.to === p1.id)
                );
                if (!exists) {
                    edges.push({ from: p1.id, to: neighbor.id, distance: neighbor.dist });
                }
            }
        }

        // ---------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ----------
        let map, currentStartPoint = null, currentRouteLine = null;
        let startMarker = null;
        const markers = {};

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è Leaflet
        function getLatLng(point) {
            let y = point.y;
            if (invertY) {
                y = imgHeight - point.y;
            }
            return [y, point.x];
        }

        // ---------- –ê–õ–ì–û–†–ò–¢–ú –î–ï–ô–ö–°–¢–†–´ ----------
        function findShortestPath(startId, targetId) {
            const graph = {};
            points.forEach(p => graph[p.id] = {});
            edges.forEach(e => {
                if (!graph[e.from][e.to] || graph[e.from][e.to] > e.distance) {
                    graph[e.from][e.to] = e.distance;
                }
                if (!graph[e.to][e.from] || graph[e.to][e.from] > e.distance) {
                    graph[e.to][e.from] = e.distance;
                }
            });

            const distances = {};
            const previous = {};
            const visited = {};
            const queue = [];

            points.forEach(p => {
                distances[p.id] = Infinity;
                previous[p.id] = null;
            });
            distances[startId] = 0;
            queue.push({ id: startId, dist: 0 });

            while (queue.length) {
                queue.sort((a, b) => a.dist - b.dist);
                const current = queue.shift();
                const currentId = current.id;
                if (visited[currentId]) continue;
                visited[currentId] = true;

                if (currentId === targetId) break;

                for (let neighborId in graph[currentId]) {
                    const alt = distances[currentId] + graph[currentId][neighborId];
                    if (alt < distances[neighborId]) {
                        distances[neighborId] = alt;
                        previous[neighborId] = currentId;
                        queue.push({ id: neighborId, dist: alt });
                    }
                }
            }

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å
            const path = [];
            let u = targetId;
            while (u !== null) {
                path.unshift(u);
                u = previous[u];
            }
            if (path.length === 1 && path[0] !== startId) return [];
            return path;
        }

        // ---------- –ü–û–°–¢–†–û–ï–ù–ò–ï –ú–ê–†–®–†–£–¢–ê ----------
        function buildRoute(fromPoint, toPoint) {
            if (currentRouteLine) {
                map.removeLayer(currentRouteLine);
                currentRouteLine = null;
            }

            let pathPoints = [];

            // –ï—Å–ª–∏ —Å—Ç–∞—Ä—Ç - –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ (–∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ)
            if (fromPoint.id === 'temp') {
                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é —Ç–æ—á–∫—É –∏–∑ –≥—Ä–∞—Ñ–∞
                let minDist = Infinity;
                let nearestPoint = null;
                for (let p of points) {
                    const d = getDist(fromPoint, p);
                    if (d < minDist) {
                        minDist = d;
                        nearestPoint = p;
                    }
                }
                if (!nearestPoint) {
                    document.getElementById('info-text').innerHTML = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à—É—é —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞.';
                    return;
                }

                const pathIds = findShortestPath(nearestPoint.id, toPoint.id);
                if (pathIds.length === 0) {
                    document.getElementById('info-text').innerHTML = '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–µ–Ω–∏—è.';
                    return;
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å: –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ + –ø—É—Ç—å –æ—Ç –±–ª–∏–∂–∞–π—à–µ–π
                pathPoints = [fromPoint, nearestPoint, ...pathIds.slice(1).map(id => points.find(p => p.id === id))];
            } else {
                // –û–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π: –æ–±–µ —Ç–æ—á–∫–∏ –∏–∑ –≥—Ä–∞—Ñ–∞
                const pathIds = findShortestPath(fromPoint.id, toPoint.id);
                if (pathIds.length === 0) {
                    document.getElementById('info-text').innerHTML = '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —Ç–æ—á–∫–∞–º–∏.';
                    return;
                }
                pathPoints = pathIds.map(id => points.find(p => p.id === id));
            }

            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é
            const latLngs = pathPoints.map(p => getLatLng(p));
            currentRouteLine = L.polyline(latLngs, {
                color: '#27ae60',
                weight: 5,
                opacity: 0.9
            }).addTo(map);

            // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            let instructions = '';
            for (let i = 0; i < pathPoints.length - 1; i++) {
                const from = pathPoints[i];
                const to = pathPoints[i+1];
                const dist = getDist(from, to).toFixed(0);
                
                let direction = '';
                if (i === 0) {
                    direction = '–í–ø–µ—Ä—ë–¥';
                } else {
                    const prev = pathPoints[i-1];
                    direction = getTurnDirection(prev, from, to);
                }
                instructions += `${direction} ${dist} –ø–∏–∫—Å. –¥–æ ${to.name}<br>`;
            }

            document.getElementById('info-text').innerHTML = `üö∂ –ú–∞—Ä—à—Ä—É—Ç –æ—Ç <b>${fromPoint.name}</b> –¥–æ <b>${toPoint.name}</b>:<br>${instructions}`;
            map.fitBounds(latLngs, { padding: [50, 50] });
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–≤–æ—Ä–æ—Ç–∞
        function getTurnDirection(prev, curr, next) {
            const v1 = { x: curr.x - prev.x, y: curr.y - prev.y };
            const v2 = { x: next.x - curr.x, y: next.y - curr.y };
            const cross = v1.x * v2.y - v1.y * v2.x;
            
            if (Math.abs(cross) < 20) return '–ü—Ä—è–º–æ';
            if (cross > 0) return '–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–µ–≤–æ';
            return '–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ';
        }

        // ---------- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–ê ----------
        function addMarker(point) {
            const latlng = getLatLng(point);
            const icon = L.divIcon({
                html: `<div style="background-color: #3498db; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${point.id}</div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const marker = L.marker(latlng, { icon: icon }).addTo(map);
            marker.bindPopup(`<b>${point.name}</b><br>${point.type || '–û—Ç–¥–µ–ª–µ–Ω–∏–µ'}`);

            marker.on('click', () => {
                if (!currentStartPoint) {
                    alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥)');
                    return;
                }
                if (currentStartPoint.id === point.id) {
                    marker.openPopup();
                    return;
                }
                buildRoute(currentStartPoint, point);
            });

            markers[point.id] = { marker, point };
        }

        // ---------- –£–°–¢–ê–ù–û–í–ö–ê –°–¢–ê–†–¢–ê –ö–õ–ò–ö–û–ú ----------
        function setStartFromClick(e) {
            if (startMarker) {
                map.removeLayer(startMarker);
            }
            const latlng = e.latlng;
            const x = latlng.lng;
            let y = latlng.lat;
            if (invertY) {
                y = imgHeight - y;
            }
            const tempPoint = {
                id: 'temp',
                name: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
                x: x,
                y: y,
                floor: 1
            };
            currentStartPoint = tempPoint;
            
            startMarker = L.circleMarker([latlng.lat, latlng.lng], {
                radius: 8,
                color: '#2980b9',
                weight: 3,
                fillColor: '#3498db',
                fillOpacity: 0.8
            }).addTo(map).bindPopup('–í—ã –∑–¥–µ—Å—å').openPopup();

            document.getElementById('info-text').innerHTML = `üìç –°—Ç–∞—Ä—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫.`;
            
            if (currentRouteLine) {
                map.removeLayer(currentRouteLine);
                currentRouteLine = null;
            }
        }

        // ---------- –ü–û–ò–°–ö –ü–û –ù–ê–ó–í–ê–ù–ò–Æ ----------
        function searchPoints(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return points.filter(p => p.name.toLowerCase().includes(lowerQuery));
        }

        // ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ----------
        function initMap() {
            map = L.map('map', {
                crs: L.CRS.Simple,
                minZoom: -2,
                maxZoom: 2,
                zoomSnap: 0.1,
                wheelPxPerZoomLevel: 120
            });

            const bounds = [[0, 0], [imgHeight, imgWidth]];
            L.imageOverlay(mapImagePath, bounds).addTo(map);
            map.fitBounds(bounds);

            points.forEach(p => addMarker(p));

            map.on('click', setStartFromClick);
        }

        // ---------- –ó–ê–ü–û–õ–ù–ï–ù–ò–ï DATALIST ----------
        function fillDatalist() {
            const datalist = document.getElementById('points-list');
            points.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                datalist.appendChild(option);
            });
        }

        // ---------- –°–ë–†–û–° –°–¢–ê–†–¢–ê ----------
        function clearStart() {
            currentStartPoint = null;
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            if (currentRouteLine) {
                map.removeLayer(currentRouteLine);
                currentRouteLine = null;
            }
            document.getElementById('info-text').innerHTML = 'üëÜ –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –∏–ª–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ä –æ—Ç–¥–µ–ª–µ–Ω–∏—è';
        }

        // ---------- –ß–¢–ï–ù–ò–ï –ü–ê–†–ê–ú–ï–¢–†–ê –ò–ó URL ----------
        function getStartPointFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const pointId = urlParams.get('point');
            if (pointId) {
                const id = parseInt(pointId);
                const point = points.find(p => p.id === id);
                if (point) {
                    currentStartPoint = point;
                    markers[point.id].marker.openPopup();
                    document.getElementById('info-text').innerHTML = `üìç –í—ã –∑–¥–µ—Å—å (–ø–æ QR): <b>${point.name}</b>. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å.`;
                } else {
                    alert('–¢–æ—á–∫–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
            }
        }

        // ---------- –ó–ê–ü–£–°–ö ----------
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            fillDatalist();
            getStartPointFromUrl();

            document.getElementById('search-btn').addEventListener('click', () => {
                const query = document.getElementById('search-input').value.trim();
                if (!query) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è');
                    return;
                }
                const results = searchPoints(query);
                if (results.length === 0) {
                    alert('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                const targetPoint = results[0];
                if (!currentStartPoint) {
                    alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥)');
                    return;
                }
                if (currentStartPoint.id === targetPoint.id) {
                    alert('–í—ã —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —ç—Ç–æ–º –æ—Ç–¥–µ–ª–µ–Ω–∏–∏');
                    return;
                }
                buildRoute(currentStartPoint, targetPoint);
            });

            document.getElementById('reset-btn').addEventListener('click', () => {
                if (currentStartPoint) {
                    const latlng = getLatLng(currentStartPoint);
                    map.setView(latlng, 0);
                    if (currentStartPoint.id === 'temp' && startMarker) {
                        startMarker.openPopup();
                    } else if (currentStartPoint.id) {
                        markers[currentStartPoint.id].marker.openPopup();
                    }
                } else {
                    alert('–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥.');
                }
            });

            document.getElementById('clear-start-btn').addEventListener('click', () => {
                clearStart();
            });

            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
        });
    </script>
</body>
</html>